# Midscene AI é›†æˆå®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº† Midscene Bridge æœåŠ¡ä¸ Python Pytest + Selenium Grid æµ‹è¯•æ¡†æ¶çš„é›†æˆæ–¹æ¡ˆã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒç»„ä»¶å¼€å‘

#### 1.1 Midscene æœåŠ¡ç®¡ç†å™¨ (`common/midscene_service.py`)

- âœ… è‡ªåŠ¨å¯åŠ¨/åœæ­¢ Node.js æœåŠ¡
- âœ… å¥åº·æ£€æŸ¥æœºåˆ¶
- âœ… è¿›ç¨‹ç®¡ç†ï¼ˆæ”¯æŒ Windows/Linux/Macï¼‰
- âœ… å•ä¾‹æ¨¡å¼ï¼Œé¿å…é‡å¤å¯åŠ¨
- âœ… è‡ªåŠ¨å®‰è£… npm ä¾èµ–
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

**ä¸»è¦åŠŸèƒ½**ï¼š

```python
# è‡ªåŠ¨å¯åŠ¨æœåŠ¡
service = MidsceneService(port=3000, auto_start=True)

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
if service.is_running():
    print("æœåŠ¡è¿è¡Œä¸­")

# åœæ­¢æœåŠ¡
service.stop()
```

#### 1.2 Midscene AI è¾…åŠ©ç±» (`common/midscene_helper.py`)

- âœ… AI æ“ä½œå°è£…ï¼ˆdo/query/assert/planï¼‰
- âœ… å¤±è´¥é‡è¯•æœºåˆ¶
- âœ… ä¸ Selenium WebDriver é›†æˆ
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… é”™è¯¯å¤„ç†å’Œè¶…æ—¶æ§åˆ¶

**ä¸»è¦åŠŸèƒ½**ï¼š

```python
helper = MidsceneHelper()

# AI æ‰§è¡Œæ“ä½œ
helper.ai_do("ç‚¹å‡»ç™»å½•æŒ‰é’®")

# AI æŸ¥è¯¢
result = helper.ai_query("é¡µé¢æ ‡é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ")

# AI æ–­è¨€
is_valid = helper.ai_assert("æ˜¯å¦æ˜¾ç¤ºç™»å½•æˆåŠŸ")

# AI è‡ªåŠ¨è§„åˆ’
helper.ai_plan("ç™»å½•ç³»ç»Ÿå¹¶éªŒè¯")
```

### 2. Pytest é›†æˆ (`conftest.py`)

#### 2.1 å‘½ä»¤è¡Œå‚æ•°

- âœ… `--enable-midscene`ï¼šå¯ç”¨ AI åŠŸèƒ½
- âœ… `--midscene-port`ï¼šæŒ‡å®šæœåŠ¡ç«¯å£
- âœ… `--cdp-port`ï¼šæŒ‡å®š CDP ç«¯å£

#### 2.2 è‡ªåŠ¨åŒ–æµç¨‹

- âœ… Session çº§åˆ«è‡ªåŠ¨å¯åŠ¨ Midscene æœåŠ¡
- âœ… è‡ªåŠ¨é…ç½® Chrome CDP ç«¯å£
- âœ… å¤±è´¥è‡ªåŠ¨é‡è¯•æœºåˆ¶
- âœ… Allure æŠ¥å‘Šé›†æˆ

#### 2.3 å¤±è´¥é‡è¯•é€»è¾‘

```python
# æµ‹è¯•å¤±è´¥æ—¶çš„å¤„ç†æµç¨‹
if test_failed and has_ai_task_marker:
    1. æ£€æŸ¥ Midscene æœåŠ¡æ˜¯å¦å¯ç”¨
    2. ä» @pytest.mark.ai_task è·å–ä»»åŠ¡æè¿°
    3. ä½¿ç”¨ AI é‡æ–°æ‰§è¡Œä»»åŠ¡
    4. å¦‚æœ AI æˆåŠŸï¼Œä¿®æ”¹æµ‹è¯•ç»“æœä¸ºé€šè¿‡
    5. åœ¨ Allure æŠ¥å‘Šä¸­æ·»åŠ æ ‡è®°
```

### 3. WebDriver å¢å¼º (`base/base_driver.py`)

- âœ… æ”¯æŒ CDP ç«¯å£å‚æ•°
- âœ… è‡ªåŠ¨æ·»åŠ  `--remote-debugging-port` å‚æ•°
- âœ… å…¼å®¹åŸæœ‰ä»£ç ï¼Œå‘åå…¼å®¹

```python
# å¯ç”¨ CDP çš„æµè§ˆå™¨
driver = base_driver.chrome_driver(cdp_port=9222)
```

### 4. Jenkins é›†æˆ

#### 4.1 å¯åŠ¨è„šæœ¬

- âœ… `start_midscene_service.sh`ï¼ˆLinux/Macï¼‰
- âœ… `start_midscene_service.bat`ï¼ˆWindowsï¼‰

**åŠŸèƒ½**ï¼š

- è‡ªåŠ¨æ£€æŸ¥ Node.js ç¯å¢ƒ
- è‡ªåŠ¨å®‰è£…ä¾èµ–
- åå°è¿è¡ŒæœåŠ¡
- å¥åº·æ£€æŸ¥
- è¿›ç¨‹ç®¡ç†ï¼ˆå¯åŠ¨/åœæ­¢/é‡å¯/çŠ¶æ€ï¼‰
- æ—¥å¿—ç®¡ç†

#### 4.2 Jenkinsfile (`Jenkinsfile.midscene`)

- âœ… å®Œæ•´çš„æµæ°´çº¿é…ç½®
- âœ… è‡ªåŠ¨å¯åŠ¨/åœæ­¢ Midscene æœåŠ¡
- âœ… ç¯å¢ƒå˜é‡é…ç½®
- âœ… æ”¯æŒ Windows/Linux
- âœ… Allure æŠ¥å‘Šé›†æˆ

### 5. é…ç½®æ–‡ä»¶

#### 5.1 æµ‹è¯•ç¯å¢ƒé…ç½® (`yml/gray.yml`)

```yaml
midscene_enabled: true
midscene_port: 3000
cdp_port: 9222
```

### 6. ç¤ºä¾‹å’Œæ–‡æ¡£

- âœ… å®Œæ•´ç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹ (`test_case/test_scenes/test_midscene_example.py`)
- âœ… è¯¦ç»†é›†æˆæ–‡æ¡£ (`MIDSCENE_INTEGRATION.md`)
- âœ… å¿«é€Ÿå…¥é—¨æŒ‡å— (`QUICK_START_MIDSCENE.md`)
- âœ… README æ›´æ–°å»ºè®® (`README_MIDSCENE_ADDITION.md`)

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Jenkins Pipeline                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€â–º å¯åŠ¨ Midscene Bridge (Node.js)
                  â”‚   - ç›‘å¬ç«¯å£ 3000
                  â”‚   - æä¾› AI æœåŠ¡ API
                  â”‚
                  â”œâ”€â–º å¯åŠ¨ Pytest
                  â”‚   â”œâ”€â–º åˆå§‹åŒ– Selenium Grid æµè§ˆå™¨
                  â”‚   â”‚   â””â”€â–º å¯ç”¨ CDP ç«¯å£ 9222
                  â”‚   â”‚
                  â”‚   â””â”€â–º æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
                  â”‚       â”œâ”€â–º Selenium æ“ä½œ
                  â”‚       â”‚   â”œâ”€â–º æˆåŠŸ â†’ æµ‹è¯•é€šè¿‡ âœ“
                  â”‚       â”‚   â””â”€â–º å¤±è´¥ â†“
                  â”‚       â”‚
                  â”‚       â””â”€â–º AI é‡è¯• (Midscene)
                  â”‚           â”œâ”€â–º é€šè¿‡ CDP è¿æ¥æµè§ˆå™¨
                  â”‚           â”œâ”€â–º æ‰§è¡Œ AI ä»»åŠ¡
                  â”‚           â”œâ”€â–º æˆåŠŸ â†’ æµ‹è¯•é€šè¿‡ âœ“
                  â”‚           â””â”€â–º å¤±è´¥ â†’ æµ‹è¯•å¤±è´¥ âœ—
                  â”‚
                  â””â”€â–º ç”Ÿæˆ Allure æŠ¥å‘Š
                      â””â”€â–º åœæ­¢ Midscene æœåŠ¡
```

### é€šä¿¡æµç¨‹

```
Python (Pytest)                Node.js (Midscene)           Chrome Browser
      â”‚                              â”‚                            â”‚
      â”‚  1. å¯åŠ¨æœåŠ¡                 â”‚                            â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
      â”‚                              â”‚                            â”‚
      â”‚  2. å¯åŠ¨æµè§ˆå™¨ï¼ˆCDP 9222ï¼‰   â”‚                            â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                              â”‚                            â”‚
      â”‚  3. Selenium æ“ä½œå¤±è´¥        â”‚                            â”‚
      â”‚                              â”‚                            â”‚
      â”‚  4. è°ƒç”¨ AI API              â”‚                            â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
      â”‚                              â”‚  5. é€šè¿‡ CDP è¿æ¥æµè§ˆå™¨    â”‚
      â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                              â”‚                            â”‚
      â”‚                              â”‚  6. æ‰§è¡Œ AI æ“ä½œ           â”‚
      â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                              â”‚                            â”‚
      â”‚  7. è¿”å›æ‰§è¡Œç»“æœ             â”‚                            â”‚
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
      â”‚                              â”‚                            â”‚
```

## ğŸ¯ ä½¿ç”¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨å¤±è´¥é‡è¯•ï¼ˆæ¨èï¼‰

```python
@pytest.mark.ai_task("è®¿é—®é¡µé¢ï¼Œç‚¹å‡»æŒ‰é’®ï¼ŒéªŒè¯ç»“æœ")
def test_with_auto_retry():
    # Selenium ä»£ç 
    driver.get("https://example.com")
    element.click()
    # å¦‚æœå¤±è´¥ï¼ŒAI è‡ªåŠ¨æ¥ç®¡
```

### æ–¹å¼äºŒï¼šç›´æ¥ä½¿ç”¨ AI

```python
def test_use_ai_directly(midscene):
    driver.get("https://example.com")
    result = midscene.ai_plan("å®Œæˆç™»å½•æµç¨‹")
    assert result.get("success")
```

### æ–¹å¼ä¸‰ï¼šæ··åˆæ¨¡å¼

```python
def test_hybrid(midscene):
    # ç®€å•æ“ä½œç”¨ Selenium
    driver.get("https://example.com")
  
    # å¤æ‚æ“ä½œç”¨ AI
    if midscene:
        midscene.ai_do("ç‚¹å‡»å¤æ‚çš„åŠ¨æ€æŒ‰é’®")
  
    # éªŒè¯ç”¨ Selenium
    assert "æˆåŠŸ" in driver.page_source
```

## ğŸ“Š æµ‹è¯•ç»“æœæ ‡è®°

åœ¨ Allure æŠ¥å‘Šä¸­ï¼š

- **AI-Retry-Success**ï¼šSelenium å¤±è´¥ï¼ŒAI é‡è¯•æˆåŠŸ
- **AI-Retry-Failed**ï¼šSelenium å¤±è´¥ï¼ŒAI é‡è¯•ä¹Ÿå¤±è´¥
- **AI-Retry-Error**ï¼šAI é‡è¯•è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸

## ğŸ”§ é…ç½®é€‰é¡¹

### Pytest å‘½ä»¤è¡Œ

```bash
# åŸºæœ¬ç”¨æ³•
pytest --enable-midscene

# è‡ªå®šä¹‰ç«¯å£
pytest --enable-midscene --midscene-port 3001 --cdp-port 9223

# æŒ‡å®šæµ‹è¯•
pytest test_file.py --enable-midscene -v
```

### Jenkins ç¯å¢ƒå˜é‡

```groovy
environment {
    ENABLE_MIDSCENE = 'true'
    MIDSCENE_PORT = '3000'
    CDP_PORT = '9222'
}
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æœ¬åœ°å¼€å‘ç¯å¢ƒ

1. **å®‰è£…ä¾èµ–**

   ```bash
   pip install -r requirements.txt
   cd test_case/test_midscene/midscene-bridge
   npm install
   ```
2. **è¿è¡Œæµ‹è¯•**

   ```bash
   pytest --enable-midscene -v
   ```

### Jenkins æµæ°´çº¿

1. **åˆ›å»º Pipeline Job**

   - Script Path: `Jenkinsfile.midscene`
2. **é…ç½®ç¯å¢ƒå˜é‡**ï¼ˆå¯é€‰ï¼‰

   - `ENABLE_MIDSCENE=true`
   - `MIDSCENE_PORT=3000`
   - `CDP_PORT=9222`
3. **è¿è¡Œæµæ°´çº¿**

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½•æ—¶å¯ç”¨ Midscene

âœ… **æ¨èå¯ç”¨**ï¼š

- æµ‹è¯•ç¯å¢ƒä¸ç¨³å®š
- é¡µé¢ç»“æ„ç»å¸¸å˜åŒ–
- éœ€è¦æé«˜æµ‹è¯•æˆåŠŸç‡
- å¤æ‚çš„äº¤äº’æµç¨‹

âŒ **ä¸æ¨èå¯ç”¨**ï¼š

- æ€§èƒ½æµ‹è¯•
- éœ€è¦ç²¾ç¡®æ§åˆ¶çš„æµ‹è¯•
- ç®€å•ç¨³å®šçš„æµ‹è¯•

### 2. ç¼–å†™ AI ä»»åŠ¡æè¿°

**å¥½çš„æè¿°**ï¼š

- æ¸…æ™°ã€å®Œæ•´ã€å…·ä½“
- åŒ…å«æ‰€æœ‰æ“ä½œæ­¥éª¤
- åŒ…å«éªŒè¯æ¡ä»¶

**ç¤ºä¾‹**ï¼š

```python
@pytest.mark.ai_task("""
1. è®¿é—®ç™»å½•é¡µé¢
2. è¾“å…¥ç”¨æˆ·å 'admin@example.com'
3. è¾“å…¥å¯†ç  'password123'
4. ç‚¹å‡»ç™»å½•æŒ‰é’®
5. éªŒè¯æ˜¯å¦æ˜¾ç¤º'ç™»å½•æˆåŠŸ'æç¤º
""")
```

### 3. æ€§èƒ½ä¼˜åŒ–

- åªåœ¨å¿…è¦æ—¶å¯ç”¨ Midscene
- ä¼˜å…ˆä½¿ç”¨ Selenium
- AI ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**

   - æ£€æŸ¥ Node.js ç‰ˆæœ¬ï¼ˆéœ€è¦ 14+ï¼‰
   - æ£€æŸ¥ç«¯å£å ç”¨
   - æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
2. **AI æ“ä½œå¤±è´¥**

   - æ£€æŸ¥ CDP è¿æ¥
   - éªŒè¯ AI é…ç½®
   - æŸ¥çœ‹ Midscene æ—¥å¿—
3. **Selenium Grid å…¼å®¹æ€§**

   - ç¡®ä¿æ”¯æŒ CDP ç«¯å£
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - éªŒè¯æµè§ˆå™¨ç‰ˆæœ¬

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**

   - å®ç° AI ç»“æœç¼“å­˜
   - ä¼˜åŒ– CDP è¿æ¥å¤ç”¨
   - å‡å°‘ AI è°ƒç”¨æ¬¡æ•°
2. **åŠŸèƒ½å¢å¼º**

   - æ”¯æŒæ›´å¤š AI æ¨¡å‹
   - å¢åŠ æµ‹è¯•å½•åƒåŠŸèƒ½
   - å®ç°æ™ºèƒ½æµ‹è¯•ç”Ÿæˆ
3. **ç›‘æ§å’Œåˆ†æ**

   - AI é‡è¯•æˆåŠŸç‡ç»Ÿè®¡
   - æ€§èƒ½æŒ‡æ ‡æ”¶é›†
   - æµ‹è¯•ç¨³å®šæ€§åˆ†æ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´é›†æˆæ–‡æ¡£](MIDSCENE-INTEGRATION.md)
- [å¿«é€Ÿå…¥é—¨æŒ‡å—](QUICK-START-MIDSCENE.md)
- [ç¤ºä¾‹æµ‹è¯•ç”¨ä¾‹](test_case/test_scenes/test_midscene_example.py)

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡é›†æˆå®ç°äº†ï¼š

âœ… **å®Œæ•´çš„ Midscene AI é›†æˆæ–¹æ¡ˆ**
âœ… **è‡ªåŠ¨å¤±è´¥é‡è¯•æœºåˆ¶**
âœ… **Jenkins æµæ°´çº¿æ”¯æŒ**
âœ… **è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹**
âœ… **è‰¯å¥½çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—**
âœ… **è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/Macï¼‰**

å¯ä»¥æ— ç¼é›†æˆåˆ°ç°æœ‰çš„ Jenkins + Pytest + Selenium Grid æµ‹è¯•æµç¨‹ä¸­ï¼Œæé«˜æµ‹è¯•çš„ç¨³å®šæ€§å’ŒæˆåŠŸç‡ã€‚
